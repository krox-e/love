<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Chamada Piravivo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .status-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
        <header class="flex flex-col items-center mb-6 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Piravivo</h1>
            <p class="text-lg text-gray-600">Lista de Chamada</p>
        </header>

        <!-- Seção para Adicionar Nomes -->
        <section class="mb-6 border-b pb-6 border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Alunos</h2>
            <div class="flex items-center space-x-2">
                <input type="text" id="student-name-input" placeholder="Nome do aluno"
                       class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all duration-200">
                <button id="add-student-btn"
                        class="p-3 bg-emerald-600 text-white rounded-xl shadow-md hover:bg-emerald-700 transition-colors duration-200 transform hover:scale-105 active:scale-100">
                    Adicionar
                </button>
            </div>
            <div id="add-error-message" class="text-red-500 text-sm mt-2 hidden">Por favor, digite um nome.</div>
        </section>

        <!-- Seção Principal da Chamada -->
        <section id="attendance-section" class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Fazer a Chamada</h2>
                <span id="current-date" class="text-gray-500 text-sm"></span>
            </div>
            
            <ul id="student-list" class="space-y-3">
                <!-- A lista de alunos e os botões de presença serão renderizados aqui -->
            </ul>
        </section>
        
        <!-- Seção de Resumo Semanal -->
        <section id="weekly-summary-section" class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo Semanal</h2>
            <div id="weekly-summary-list" class="space-y-2">
                <!-- O resumo semanal será renderizado aqui -->
            </div>
        </section>

        <footer class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
            <button id="clear-data-btn"
                    class="p-2 text-sm bg-red-100 text-red-600 rounded-xl hover:bg-red-200 transition-colors duration-200">
                Limpar Todos os Dados
            </button>
            <div id="clear-message" class="text-sm text-center font-semibold text-red-500 hidden">
                Dados removidos com sucesso.
            </div>
        </footer>
    </div>

    <script>
        const studentNameInput = document.getElementById('student-name-input');
        const addStudentBtn = document.getElementById('add-student-btn');
        const studentList = document.getElementById('student-list');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const addErrorMessage = document.getElementById('add-error-message');
        const clearMessage = document.getElementById('clear-message');
        const currentDateSpan = document.getElementById('current-date');
        const weeklySummaryList = document.getElementById('weekly-summary-list');

        const STUDENTS_KEY = 'piravivo-students';
        const ATTENDANCE_KEY = 'piravivo-attendance';
        const WEEK_DAYS = [1, 2, 3, 4]; // Segunda(1), Terça(2), Quarta(3), Quinta(4)

        // Função utilitária para obter a data de hoje no formato AAAA-MM-DD
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // --- Funções de Carregamento e Salvamento ---

        function loadStudents() {
            try {
                const studentsData = localStorage.getItem(STUDENTS_KEY);
                return studentsData ? JSON.parse(studentsData) : [];
            } catch (e) {
                console.error("Erro ao carregar a lista de alunos:", e);
                return [];
            }
        }

        function saveStudents(students) {
            try {
                localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
            } catch (e) {
                console.error("Erro ao salvar a lista de alunos:", e);
            }
        }

        function loadAttendance() {
            try {
                const attendanceData = localStorage.getItem(ATTENDANCE_KEY);
                return attendanceData ? JSON.parse(attendanceData) : {};
            } catch (e) {
                console.error("Erro ao carregar os registros de presença:", e);
                return {};
            }
        }

        function saveAttendance(attendance) {
            try {
                localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(attendance));
            } catch (e) {
                console.error("Erro ao salvar os registros de presença:", e);
            }
        }

        // --- Funções de Renderização ---

        function renderStudents() {
            const students = loadStudents();
            const attendance = loadAttendance();
            const today = getTodayDate();

            // Pega o registro de hoje ou um objeto vazio se não existir
            const todayAttendance = attendance[today] || {};

            studentList.innerHTML = '';
            
            // Renderiza cada aluno na lista
            students.forEach(student => {
                const status = todayAttendance[student] || ''; // 'P', 'F', 'A' ou ''
                
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm';
                
                // Novo container para nome e status, que ficará alinhado verticalmente
                const nameAndStatusContainer = document.createElement('div');
                nameAndStatusContainer.className = 'flex flex-col flex-1';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-gray-800 font-medium';
                nameSpan.textContent = student;
                
                // Elemento para exibir o status como uma palavra completa
                const statusDisplay = document.createElement('span');
                statusDisplay.className = `text-xs font-semibold mt-1`;
                
                // Define a palavra e a cor do indicador de status
                switch (status) {
                    case 'P':
                        statusDisplay.textContent = 'Presença';
                        statusDisplay.className += ' text-emerald-500';
                        break;
                    case 'F':
                        statusDisplay.textContent = 'Falta';
                        statusDisplay.className += ' text-red-500';
                        break;
                    case 'A':
                        statusDisplay.textContent = 'Atestado';
                        statusDisplay.className += ' text-gray-500';
                        break;
                    default:
                        statusDisplay.textContent = ''; // Limpa o texto se o status não estiver definido
                        break;
                }

                nameAndStatusContainer.appendChild(nameSpan);
                nameAndStatusContainer.appendChild(statusDisplay);

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2';
                
                // Botão de Presença
                const presentBtn = createStatusButton('P', status === 'P' ? 'bg-emerald-500 text-white' : 'bg-white text-emerald-500 border border-emerald-500');
                presentBtn.onclick = () => updateAttendance(student, 'P');
                
                // Botão de Falta
                const absentBtn = createStatusButton('F', status === 'F' ? 'bg-red-500 text-white' : 'bg-white text-red-500 border border-red-500');
                absentBtn.onclick = () => updateAttendance(student, 'F');
                
                // Botão de Atestado
                const attestedBtn = createStatusButton('A', status === 'A' ? 'bg-gray-500 text-white' : 'bg-white text-gray-500 border border-gray-500');
                attestedBtn.onclick = () => updateAttendance(student, 'A');

                buttonContainer.appendChild(presentBtn);
                buttonContainer.appendChild(absentBtn);
                buttonContainer.appendChild(attestedBtn);
                
                li.appendChild(nameAndStatusContainer);
                li.appendChild(buttonContainer);
                studentList.appendChild(li);
            });

            // Chama a renderização do resumo semanal após a renderização da lista diária
            renderWeeklySummary();
        }

        // Função auxiliar para criar botões de status
        function createStatusButton(text, className) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = `status-button rounded-full ${className} hover:scale-105 transform`;
            return btn;
        }

        // --- Funções de Lógica ---

        // Adiciona um novo aluno à lista
        function addStudent() {
            const name = studentNameInput.value.trim();
            if (name === '') {
                addErrorMessage.classList.remove('hidden');
                studentNameInput.focus();
                return;
            }
            addErrorMessage.classList.add('hidden');

            const students = loadStudents();
            if (!students.includes(name)) {
                students.push(name);
                saveStudents(students);
                renderStudents();
            }
            studentNameInput.value = '';
        }
        
        // Atualiza o registro de presença de um aluno
        function updateAttendance(studentName, status) {
            const attendance = loadAttendance();
            const today = getTodayDate();
            
            // Inicializa o registro do dia se ele não existir
            if (!attendance[today]) {
                attendance[today] = {};
            }

            // Atualiza o status do aluno no dia de hoje
            attendance[today][studentName] = status;
            saveAttendance(attendance);
            renderStudents(); // Re-renderiza a lista para atualizar os botões
        }

        // Limpa todos os dados salvos no localStorage
        function clearAllData() {
            localStorage.removeItem(STUDENTS_KEY);
            localStorage.removeItem(ATTENDANCE_KEY);
            renderStudents();
            clearMessage.classList.remove('hidden');
            setTimeout(() => {
                clearMessage.classList.add('hidden');
            }, 3000);
        }

        // --- Lógica e Renderização do Resumo Semanal ---

        function calculateWeeklySummary() {
            const students = loadStudents();
            const attendanceData = loadAttendance();
            const today = new Date();
            const weeklySummary = {};

            // Encontra as datas de segunda, terça, quarta e quinta da semana atual
            const weekDates = [];
            const firstDayOfWeek = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1); // Pega a segunda-feira da semana
            for (let i = 0; i < 4; i++) {
                const day = new Date(today.getFullYear(), today.getMonth(), firstDayOfWeek + i);
                weekDates.push(day.toISOString().split('T')[0]);
            }
            
            const totalLetiveDays = 4;

            // Calcula a porcentagem de presença para cada aluno
            students.forEach(student => {
                let attendedDays = 0;
                
                weekDates.forEach(date => {
                    const dailyAttendance = attendanceData[date] || {};
                    if (dailyAttendance[student] === 'P') {
                        attendedDays++;
                    }
                });
                
                const percentage = (attendedDays / totalLetiveDays) * 100;
                weeklySummary[student] = percentage.toFixed(0); // Arredonda para o número inteiro mais próximo
            });

            return weeklySummary;
        }

        function renderWeeklySummary() {
            const summary = calculateWeeklySummary();
            weeklySummaryList.innerHTML = '';

            const students = loadStudents();
            if (students.length === 0) {
                weeklySummaryList.innerHTML = '<p class="text-sm text-gray-500">Adicione alunos para ver o resumo semanal.</p>';
                return;
            }

            for (const student in summary) {
                const percentage = summary[student];
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-xl';
                item.innerHTML = `
                    <span class="font-semibold text-gray-700">${student}</span>
                    <span class="text-lg font-bold ${percentage >= 75 ? 'text-emerald-500' : (percentage > 50 ? 'text-yellow-500' : 'text-red-500')}">
                        ${percentage}%
                    </span>
                `;
                weeklySummaryList.appendChild(item);
            }
        }

        // --- Event Listeners e Inicialização ---
        
        addStudentBtn.addEventListener('click', addStudent);
        studentNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addStudent();
            }
        });
        clearDataBtn.addEventListener('click', clearAllData);

        window.onload = () => {
            const todayFormatted = new Date().toLocaleDateString('pt-BR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            currentDateSpan.textContent = todayFormatted;
            renderStudents();
        };

    </script>
</body>
</html>
